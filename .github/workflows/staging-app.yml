name: Release the tests on Staging
on:
  push:
    branches: [ develop ]

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Set up node ğŸ’»
        uses: actions/setup-node@v3
        with:
          node-version: 14

      - name: Install dependencies ğŸ§¶
        run: yarn install --frozen-lockfile --non-interactive

      - name: Install ğŸ“¦
        uses: cypress-io/github-action@v3
        with:
          runTests: false

      - name: Set Cypress version ğŸ
        id: cypress
        run: echo "::set-output name=version::$(node ./src/print-cypress-version)"

      - name: Print Cypress version ğŸ–¨ï¸
        run: echo "Cypress version is ${{ steps.cypress.outputs.version }}"

      - name: Save built folders ğŸ†™
        uses: actions/upload-artifact@v2
        with:
          name: built
          path: cypress/integration

  cypress-run:
    runs-on: ubuntu-latest
    needs: install
    strategy:
      fail-fast: false
      matrix:
        containers: [1,2,3]

    steps: 
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Set up node ğŸ’»
        uses: actions/setup-node@v3
        with:
          node-version: 14

      - name: Download built folders â¬
        uses: actions/download-artifact@v2
        with:
          name: built

      - name: Cypress tests ğŸ§ª
        uses: cypress-io/github-action@v3
        continue-on-error: true
        with:
          record: true
          parallel: true
          browser: chrome
          command: yarn run cypress run
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  report:
    runs-on: ubuntu-latest
    needs: [install, cypress-run]
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Set up node ğŸ’»
        uses: actions/setup-node@v3
        with:
          node-version: 14
          
      - name: Merge JSON ğŸ“
        run: yarn mocha:merge 

      - name: Create report ğŸ“
        run: yarn mocha:marge:ci

      - name: Publish report ğŸ“ˆ
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/results/mochawesome

      - name: Telegram notification ğŸ””
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: html
          message: |
            <b>Author:</b> ${{ github.actor }}
            <b>Message:</b> ${{ github.event.commits[0].message }}
            
            <b>Repository:</b> ${{ github.repository }}
            
            <b>See changes:</b> <a href="https://github.com/${{ github.repository }}/commit/${{github.sha}}">here</a>

            <b>See report:</b> <a href="https://vhonorato.github.io/ex_mod_22/">here</a>

